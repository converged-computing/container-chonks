FROM php:5.5-fpm

ENV DEBIAN_FRONTEND noninteractive

# persistent / runtime deps
# refer: https://gist.github.com/g-alonso/5726448
RUN apt-get update && \
  apt-get install -y libmcrypt-dev libpng12-dev libxslt-dev libtidy-dev --no-install-recommends supervisor bzip2 libbz2-dev libssl-dev expect && \
  rm -rf /var/lib/apt/lists/*

RUN docker-php-ext-install mysqli mcrypt gd mbstring zip bz2 exif gettext

##<autogenerated>##

# install nginx
RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys ABF5BD827BD9BF62 && \
    echo "deb http://www.nginx.org/packages/debian/ wheezy nginx" > /etc/apt/sources.list.d/nginx.list && \
    apt-get update && \
    apt-get install -y nginx && \
    apt-get clean && \
    echo -n > /var/lib/apt/extended_states

RUN usermod -u 1000 www-data

###</autogenerated>##

VOLUME /var/www/html
ADD php.ini /usr/local/etc/php/php.ini
ADD php-fpm.conf /usr/local/etc/
ADD nginx.conf /etc/nginx/nginx.conf
ADD supervisord.conf /etc/supervisor/supervisord.conf
ADD supervisord-*.conf /etc/supervisor/conf.d/
ADD run.sh /run.sh
RUN chmod 700 /run.sh

CMD ["/run.sh"]
EXPOSE 80
